# purescript-typescript-genforeign

This package contains set of functions for parsing TypeScript declaration files (*.d.ts) and generating PureScript code from it.

## Installation
This library is still in development and I haven't figured out how to publish.
I am currently testing code generation with the [three](https://github.com/mrdoob/three.js/) library. I have notes about the progress below.

Installation must be manual. This is highly experimental, but if you assume the risk, feel free to use it. Do note that (as I've seen) people usually recommend writing bindings only for the parts you are going t o use and as you use them.

Spago reference is [here](https://github.com/purescript/spago#add-a-package-to-the-package-set)

```nix
let upstream = -- <package set URL here, (don't change this)>
in  upstream
  with typescript-genforeign =
    { dependencies =
        [ "argonaut"
        , "argonaut-codecs"
        , "argonaut-core"
        , "argonaut-generic"
        , "console"
        , "effect"
        , "foldable-traversable"
        , "generics-rep"
        , "integers"
        ]
    , repo =
        "https://github.com/adrianloma/purescript-typescript-genforeign""
    , version =
        "master"  -- branch, tag, or commit hash
    }
```

```shell
spago install typescript-genforeign
```
## Limitations
Depending on the library you are consuming, the `purescript-functions` library might not be enough (ie. you get errors of the type `couldn't find runFn18`). You will need to fork the `purescript-functions` library, add the appropriate functions, and add it to your spago.dhall file in order to compile. I haven't thought of a better way to get around this problem.


In theory, it shouldn't be too much issue to curry the functions as they are generated by the javascript generator. That way, it wouldn't be necessary to have the "Impl" uncurried functions and the curried functions.

Right now static methods aren't parsed as static and hence you need to pass an instance to the static method. 

Namespaces get completely ignored.

Union types with literals (eg. (1 | 2 | "3" )) are broken.

Some classes are generic (eg Curve<T>) this breaks a lot of things. This is interpreted as being a container type, but also a class. So this generator can't figure out not to output `type Class` and `type Class a`, and outputs both. 

## Real world scenario
As a reference library, I am currently using three.js. I haven't tested if the functions work. I've mostly concentrated on fixing bugs. According to `ls -lR | grep ".d.ts" | wc -l` there are 242 typescript declaration files in `node_modules/three/src/`. Out of those 242, 16 files don't get processed. Of those 16 files, 4 are only re-exports, 3 only export variables/enums, 6 fail due to being namespaced. 

These are several files which fail compleltely, mainly because of being namespaced or consisting of only constants and enums.
* `node_modules/three/src/Three.d.ts` : Fails because it's a file with no declarations, only exports
* `node_modules/three/src/animation/AnimationUtils.d.ts` : Namespaced
* `node_modules/three/src/audio/AudioContext.d.ts` : Fails because it's just this code: `export const AudioContext: AudioContext;`
* `node_modules/three/src/constants.d.ts` : It only has exports and enums.
* `node_modules/three/src/extras/ImageUtils.d.ts` : Namespaced
* `node_modules/three/src/extras/core/Interpolations.d.ts` : Namespaced
* `node_modules/three/src/extras/curves/Curves.d.ts` : Only re-exports
* `node_modules/three/src/geometries/Geometries.d.ts` : Only re-exports
* `node_modules/three/src/loaders/Cache.d.ts` : Namespaced
* `node_modules/three/src/materials/Materials.d.ts` : Only re-exports
* `node_modules/three/src/math/MathUtils.d.ts` : Namespaced
* `node_modules/three/src/renderers/shaders/ShaderChunk.d.ts` : It exports a variable. It is a typeliteral, since it's declared inline. It could be converted to a real PS type, but I don't see the value of doing it for just this file.  

Then these are the rest of the problematic files:
* `src/Three/Animation/PropertyBinding.purs`: Fails due to referencing a namespaced part of the file.
* `src/Three/Materials/Material.purs`: Fails due to union types with literal strings.
* `src/Three/Core/GLBufferAttribute.purs`: Fails due to union types with literal numbers.
* `src/Three/Extras/Core/Curve.purs`: Fails due to the `type Class =` and `type Class a =` problem described above, since it is a class with a generic parameter.

Once these files are deleted, the library compiles. There are known issues, such as static methods, and unkown issues. The resulting library hasn't been run. Also, it requires a forked version of `purescript-functions` since it needs to uncurry `Fn17` and the purescript library reaches only to `Fn10`. 

## Documentation

You can build the documentation by running `spago docs`.


## Todos
- static methods get read like instance methods
- namespaced code doesn't parse
-- a module calling another namespace in the same file fails.
- Union types are broken when the types are literals:
-- someParam: 1 | 2 | "some literal"
- Uncurried library is insufficient. Rewrite JS function generation to use uncurried functions.
- Code is a mess. 
