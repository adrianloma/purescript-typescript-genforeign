# purescript-typescript-genforeign

This package contains set of functions for parsing TypeScript declaration files (*.d.ts) and generating PureScript code from it.

## Installation
This library is still in development and I haven't figured out how to publish.
I am currently testing code generation with the [three](https://github.com/mrdoob/three.js/) library. I have notes about the progress below.

Installation must be manual. This is highly experimental, but if you assume the risk, feel free to use it. Do note that (as I've seen) people usually recommend writing bindings only for the parts you are going t o use and as you use them.

Spago reference is [here](https://github.com/purescript/spago#add-a-package-to-the-package-set)

```nix
let upstream = -- <package set URL here, (don't change this)>
in  upstream
  with typescript-genforeign =
    { dependencies =
        [ "argonaut"
        , "argonaut-codecs"
        , "argonaut-core"
        , "argonaut-generic"
        , "console"
        , "effect"
        , "foldable-traversable"
        , "generics-rep"
        , "integers"
        ]
    , repo =
        "https://github.com/adrianloma/purescript-typescript-genforeign""
    , version =
        "master"  -- branch, tag, or commit hash
    }
```

```shell
spago install typescript-genforeign
```
## Limitations
Depending on the library you are consuming, the `purescript-functions` library might not be enough (ie. you get errors of the type `couldn't find runFn18`). You will need to fork the `purescript-functions` library, add the appropriate functions, and add it to your spago.dhall file in order to compile. I haven't thought of a better way to get around this problem.


In theory, it shouldn't be too much issue to curry the functions as they are generated by the javascript generator. That way, it wouldn't be necessary to have the "Impl" uncurried functions and the curried functions.

Right now static methods aren't parsed as static and hence you need to pass an instance to the static method. Namespaces get completely ignored. Union types with literals (eg. (1 | 2 | "3" )) are broken.

Some classes are generic (eg Curve<T>) this breaks a lot of things. This is interpreted as being a container type, but also a class. So this generator can't figure out not to output `type Class` and `type Class a`, and outputs both. 

In general, I made this library as a beginner of functional programming, and having no knowledge of TypeScript. Also, the TypeScript compiler API was a pain to use and it is not well documented, which resulted in a lot of monkeypatching in the `Parse.js` file while adding support to more and more types and structures as I was encountering them.

If I were to write this again, I might have spent more time modelling more closely the TypeScript compiler's AST, which would ideally model some kind of grammar, but I could never find a description of the declaration file grammar. And I'd instead try to understand the API better to have it print a nice AST in JSON, and then parse that, since I was replicating some of the work the compiler is already equipped to do.

These things impact the limits of this library and how much can be feasibly added.

## Real world scenario
As a reference library, I am currently using three.js. I haven't tested if the functions work. I've mostly concentrated on fixing bugs. According to `ls -lR | grep ".d.ts" | wc -l` there are 242 typescript declaration files in `node_modules/three/src/`. Out of those 242, 16 files don't get processed. Of those 16 files, 4 are only re-exports, 3 only export variables/enums, 6 fail due to being namespaced. 

These are several files which fail compleltely, mainly because of being namespaced or consisting of only constants and enums.
* `node_modules/three/src/Three.d.ts` : Fails because it's a file with no declarations, only exports
* `node_modules/three/src/animation/AnimationUtils.d.ts` : Namespaced
* `node_modules/three/src/audio/AudioContext.d.ts` : Fails because it's just this code: `export const AudioContext: AudioContext;`
* `node_modules/three/src/constants.d.ts` : It only has exports and enums.
* `node_modules/three/src/extras/ImageUtils.d.ts` : Namespaced
* `node_modules/three/src/extras/core/Interpolations.d.ts` : Namespaced
* `node_modules/three/src/extras/curves/Curves.d.ts` : Only re-exports
* `node_modules/three/src/geometries/Geometries.d.ts` : Only re-exports
* `node_modules/three/src/loaders/Cache.d.ts` : Namespaced
* `node_modules/three/src/materials/Materials.d.ts` : Only re-exports
* `node_modules/three/src/math/MathUtils.d.ts` : Namespaced
* `node_modules/three/src/renderers/shaders/ShaderChunk.d.ts` : It exports a variable. It is a typeliteral, since it's declared inline. It could be converted to a real PS type, but I don't see the value of doing it for just this file.  

Then these are the rest of the problematic files:
* `src/Three/Animation/PropertyBinding.purs`: Fails due to referencing a namespaced part of the file.
* `src/Three/Materials/Material.purs`: Fails due to union types with literal strings.
* `src/Three/Core/GLBufferAttribute.purs`: Fails due to union types with literal numbers.
* `src/Three/Extras/Core/Curve.purs`: Fails due to the `type Class =` and `type Class a =` problem described above, since it is a class with a generic parameter.

Once these files are deleted, the library compiles. There are known issues, such as static methods, and unkown issues. The resulting library hasn't been run. Also, it requires a forked version of `purescript-functions` since it needs to uncurry `Fn17` and the purescript library reaches only to `Fn10`. 

I've also made preliminary work with the `fs` part of the `node` library. It fails for other reason than the three library. It is only 1 file (which describes the whole `fs` module), and that file fails, in comparison, the three library is 242 files and 16 fail. The declaration file for `fs` can be found [here](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/types/node/ts3.1/fs.d.ts). It heavily uses namespaces, overloading, illegal PureScript characters, and numerous other TypeScript features I am not well acquainted with (TypeScript's intersection types, overloaded functions in interfaces, etc).


## Documentation

You can build the documentation by running `spago docs`.


## Todos
These are bugs I need to keep track of. They are unlikely to get fixed anytime soon.
- static methods get read like instance methods
- namespaced code doesn't parse
--- Now it does, but it is unscoped. Depending on the type of namespace, the resulting call in JS could be either scoped or unscoped. `Namespace.function` or just `function`. 
-- a module calling another namespace in the same file fails.
- Union types are broken when the types are literals:
-- someParam: 1 | 2 | "some literal"
- Union types broken when Type Literals are used, and don't have de-duping.
```
(from parsing @types/node/fs.d.ts)
type UT_Options_{encoding::MaybeUnit,flag::MaybeString}UnitUnit =  { encoding :: (Maybe Unit), flag :: (Maybe String) } |+| Unit |+| Unit
```
- Uncurried library is insufficient. Rewrite JS function generation to use uncurried functions.
- Code is a mess. 
- illegal characters (`&`, `@`)
